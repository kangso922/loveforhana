<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- í•„ìˆ˜ Open Graph íƒœê·¸ë“¤ -->
    <meta property="og:title" content="í•˜ë‚˜ì˜ ê·¸ë¦¼ ê°¤ëŸ¬ë¦¬ ğŸ¨" />
    <meta property="og:description" content="í•˜ë‚˜ë–µê°œì˜ ê°ì„± ê°¤ëŸ¬ë¦¬ ğŸŒ¸ ì¡°ìš©íˆ ê°ìƒí•´ìš”." />
    <meta property="og:image" content="https://kangso922.github.io/loveforhana/images/image8.jpg" />
    <meta property="og:url" content="https://kangso922.github.io/" />
    <meta property="og:type" content="website" />
    <title>í•˜ë‚˜ì˜ ê·¸ë¦¼ ê°¤ëŸ¬ë¦¬ ğŸ¨</title>
    <link rel="stylesheet" href="style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet"/>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J16EN3BDWW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-J16EN3BDWW');
    </script>
</head>
<body>
<div class="player">
    <audio id="player" src="music/bgm.mp3"></audio>
    <button onclick="togglePlay()" id="playPauseBtn" class="play">â™«</button>
    <div id="bar" class="bar"></div>
</div>
<div class="container">
    <h1>í•˜ë‚˜ë–µê°œì˜ ê·¸ë¦¼ë“¤ âœ¨</h1>
    <div class="gallery">
        <div class="item"><img src="images/image1.jpg" alt="ê·¸ë¦¼ 1"/></div>
        <div class="item"><img src="images/image2.jpg" alt="ê·¸ë¦¼ 2"/></div>
        <div class="item"><img src="images/image3.jpg" alt="ê·¸ë¦¼ 3"/></div>
        <div class="item"><img src="images/image4.jpg" alt="ê·¸ë¦¼ 4"/></div>
        <div class="item"><img src="images/image6.jpg" alt="ê·¸ë¦¼ 6"/></div>
        <div class="item"><img src="images/image7.jpg" alt="ê·¸ë¦¼ 7"/></div>
        <div class="item"><img src="images/image8.jpg" alt="ê·¸ë¦¼ 8"/></div>
        <div class="item"><img src="images/image5.jpg" alt="ê·¸ë¦¼ 5"/></div>
    </div>

    <!--<div class="music-control">
        <button onclick="document.getElementById('bgm').play()">ğŸµ ìŒì•… ë“£ê¸°</button>
    </div>-->
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal">
    <span class="close" id="close">Ã—</span>
    <img class="modal-content" id="modal-img"/>
</div>

<audio id="bgm" loop>
    <source src="music/bgm.mp3" type="audio/mpeg"/>
    ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
</audio>

<script>
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const closeBtn = document.getElementById('close');
    const audio = document.getElementById("player");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const bar = document.getElementById("bar");

    let scrollY = 0;
    let petalIntervalId = null; // ë²šê½ƒ ìƒì„± interval ID ì €ì¥ìš©

    // --- ëª¨ë‹¬ ì—´ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    document.querySelectorAll('.item img').forEach(img => {
        img.addEventListener('click', () => {
            modalImg.src = img.src;
            scrollY = window.scrollY; // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥

            // body ê³ ì • (ìŠ¤í¬ë¡¤ ë°©ì§€)
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';

            modal.style.display = 'flex';

            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
            sessionStorage.setItem('scrollY', scrollY);
            sessionStorage.setItem('isModalOpen', 'true');
            sessionStorage.setItem('modalImage', img.src);

            // í•˜íŠ¸/íŒŒí‹°í´ ìƒì„± (í´ë¦­ ì‹œ íš¨ê³¼)
            // setTimeoutìœ¼ë¡œ ê°ì‹¸ëŠ” ê²ƒì€ getBoundingClientRectê°€ ì •í™•í•œ ê°’ì„ ë°˜í™˜í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨ì¼ ìˆ˜ ìˆìŒ
            setTimeout(() => {
                const rect = modalImg.getBoundingClientRect();
                // getBoundingClientRectëŠ” viewport ê¸°ì¤€ì´ë¯€ë¡œ scrollX/Yë¥¼ ë”í•  í•„ìš” ì—†ìŒ
                createHeartsFromBox(rect.left, rect.top, rect.width, rect.height);
                createParticlesFromBox(rect.left, rect.top, rect.width, rect.height);
            }, 0);
        });
    });

    // --- ëª¨ë‹¬ ë‹«ê¸° ---
    function closeModal() {
        modal.style.display = 'none';

        // body ìŠ¤íƒ€ì¼ ì›ìƒë³µêµ¬ ë° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        window.scrollTo(0, scrollY); // ì €ì¥ëœ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¡œ ì´ë™

        sessionStorage.setItem('isModalOpen', 'false'); // ëª¨ë‹¬ ë‹«í˜ ìƒíƒœ ì €ì¥
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ë¯¸ì§€ í´ë¦­ ì‹œëŠ” ë‹«íˆì§€ ì•ŠìŒ)
        if (event.target === modal) {
            closeModal();
        }
    }); // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° ìˆ˜ì •

    // --- í•˜íŠ¸ ìƒì„± í•¨ìˆ˜ ---
    function createHeartsFromBox(x, y, width, height) {
        // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ì— SVG fetch ì‹œë„ (ë” ì•ˆì •ì )
        if (!document.getElementById('modal-img').complete) {
            console.warn("Modal image not loaded yet, skipping hearts.");
            return;
        }
        // SVG ìºì‹± ë°©ì§€ ìœ„í•´ Date.now() ì‚¬ìš©ì€ ìœ íš¨
        fetch("images/heart-svgrepo-com.svg?cache=" + Date.now())
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.text();
            })
            .then(svgText => {
                let cleanedSvg = svgText
                    .replace(/<svg([^>]*)width="[^"]*"([^>]*)>/, '<svg$1$2>')
                    .replace(/<svg([^>]*)height="[^"]*"([^>]*)>/, '<svg$1$2>')
                    .replace(/fill="none"/g, 'fill="#ff6b81"')
                    .replace(/stroke="#[^"]*"/g, 'stroke="none"');

                // ì¢Œí‘œ ê³„ì‚°ì€ viewport ê¸°ì¤€ì´ë¯€ë¡œ scrollX/Y ë¶ˆí•„ìš”
                const centerX = x + width / 2;
                const centerY = y + height / 2;
                const maxRadius = Math.min(width, height) * 0.6; // ë°˜ê²½ ì•½ê°„ ì¤„ì„

                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * maxRadius;
                    const offsetX = Math.cos(angle) * radius;
                    const offsetY = Math.sin(angle) * radius;
                    const posX = centerX + offsetX;
                    const posY = centerY + offsetY;

                    const wrapper = document.createElement("div");
                    wrapper.classList.add("floating-heart");
                    wrapper.style.position = "fixed"; // bodyê°€ fixedì¼ ë•Œ fixed ì‚¬ìš©
                    wrapper.style.left = `${posX}px`;
                    wrapper.style.top = `${posY}px`;
                    wrapper.style.width = "32px";
                    wrapper.style.height = "32px";
                    wrapper.innerHTML = cleanedSvg;

                    document.body.appendChild(wrapper);
                    setTimeout(() => wrapper.remove(), 1500);
                }
            }).catch(error => console.error("Error fetching or processing heart SVG:", error));
    }

    // --- íŒŒí‹°í´ ìƒì„± í•¨ìˆ˜ ---
    function createParticlesFromBox(x, y, width, height) {
        if (!document.getElementById('modal-img').complete) {
            console.warn("Modal image not loaded yet, skipping particles.");
            return;
        }
        for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');

            const angle = Math.random() * 2 * Math.PI;
            const radius = Math.random() * Math.min(width, height) * 0.6; // ë°˜ê²½ ì•½ê°„ ì¤„ì„
            const offsetX = Math.cos(angle) * radius;
            const offsetY = Math.sin(angle) * radius;

            const px = x + width / 2 + offsetX;
            const py = y + height / 2 + offsetY;

            particle.style.left = `${px}px`;
            particle.style.top = `${py}px`;
            particle.style.position = 'fixed'; // bodyê°€ fixedì¼ ë•Œ fixed ì‚¬ìš©

            const moveAngle = Math.random() * 2 * Math.PI; // ì´ë™ ë°©í–¥ ëœë¤
            const dist = Math.random() * 60 + 20; // ì´ë™ ê±°ë¦¬ ëœë¤

            // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ CSS ë³€ìˆ˜ ì„¤ì •
            particle.style.setProperty('--dest-x', `${Math.cos(moveAngle) * dist}px`);
            particle.style.setProperty('--dest-y', `${Math.sin(moveAngle) * dist}px`);
            particle.style.background = ['#ffc1cc', '#ffd6e8', '#ffb3b3', '#ffe4ec'][Math.floor(Math.random() * 4)];

            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 800); // 0.8ì´ˆ í›„ ì œê±°
        }
    }

    // --- ë²šê½ƒì ìƒì„± í•¨ìˆ˜ ---
    function createPetal() {
        const petal = document.createElement("div");
        petal.classList.add("petal");
        petal.innerText = "ğŸŒ¸"; // í…ìŠ¤íŠ¸ ëŒ€ì‹  ì´ë¯¸ì§€ë‚˜ SVG ì‚¬ìš© ê°€ëŠ¥

        const startLeft = Math.random() * window.innerWidth;
        const size = Math.random() * 14 + 12;
        const duration = Math.random() * 5 + 5;
        const delay = Math.random() * 5;
        const xDrift = Math.random() * 100 - 50 + "px"; // ì¢Œìš° í”ë“¤ë¦¼

        petal.style.left = `${startLeft}px`;
        petal.style.fontSize = `${size}px`;
        petal.style.animationDuration = `${duration}s`;
        petal.style.animationDelay = `${delay}s`;
        petal.style.setProperty('--x-drift', xDrift);

        document.body.appendChild(petal);

        // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
        setTimeout(() => petal.remove(), (duration + delay) * 1000);
    }

    // --- ì˜¤ë””ì˜¤ ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€ ---
    function togglePlay() {
        if (!audio) return; // audio ìš”ì†Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (audio.paused) {
            audio.play().then(() => {
                playPauseBtn.textContent = "ğŸ”‡";
                bar.style.display = "block";
                sessionStorage.setItem('audioPaused', 'false');
                sessionStorage.setItem('audioTime', audio.currentTime);
            }).catch(error => {
                console.error("Audio play failed:", error);
                // ìë™ ì¬ìƒ ì‹¤íŒ¨ ì‹œ UI ì—…ë°ì´íŠ¸ ë°©ì§€ ë˜ëŠ” ì´ˆê¸°í™”
                playPauseBtn.textContent = "â™«";
                bar.style.display = "none";
                sessionStorage.setItem('audioPaused', 'true');
            });
        } else {
            audio.pause();
            playPauseBtn.textContent = "â™«";
            bar.style.display = "none";
            sessionStorage.setItem('audioPaused', 'true');
            sessionStorage.setItem('audioTime', audio.currentTime);
        }
    }
    // ë²„íŠ¼ í´ë¦­ ì‹œ í† ê¸€ í•¨ìˆ˜ ì—°ê²°
    playPauseBtn.addEventListener('click', togglePlay);


    // --- ìƒíƒœ ë³µì› í•¨ìˆ˜ (ìœ ì¼í•œ ì •ì˜) ---
    function restoreAppState() {
        console.log('[Web] Attempting to restore app state...');
        const lastScroll = sessionStorage.getItem('scrollY');
        const isModalOpen = sessionStorage.getItem('isModalOpen');
        const modalImage = sessionStorage.getItem('modalImage');
        const audioPaused = sessionStorage.getItem('audioPaused');
        const audioTime = sessionStorage.getItem('audioTime');

        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
        if (lastScroll) {
            // í˜ì´ì§€ ë¡œë“œ ë° ë Œë”ë§ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì•½ê°„ì˜ ì§€ì—° í›„ ìŠ¤í¬ë¡¤ ë³µì› ì‹œë„
            setTimeout(() => {
                window.scrollTo(0, parseInt(lastScroll));
                console.log('[Web] Scroll restored to:', lastScroll);
            }, 100); // 100ms ì •ë„ ì§€ì—° (í•„ìš”ì— ë”°ë¼ ì¡°ì ˆ)
        }

        // ëª¨ë‹¬ ìƒíƒœ ë³µì›
        if (isModalOpen === 'true' && modalImage) {
            // ì´ë¯¸ì§€ ë¡œë“œ í›„ ëª¨ë‹¬ í‘œì‹œ ê³ ë ¤
            modalImg.onload = () => {
                modal.style.display = 'flex';
                // body ê³ ì • ìŠ¤íƒ€ì¼ ì ìš©
                document.body.style.position = 'fixed';
                document.body.style.top = `-${lastScroll || 0}px`; // lastScroll ì—†ì„ ê²½ìš° ëŒ€ë¹„
                document.body.style.left = '0';
                document.body.style.right = '0';
                document.body.style.width = '100%';
                console.log('[Web] Modal restored:', modalImage);
                modalImg.onload = null; // onload í•¸ë“¤ëŸ¬ ì œê±°
            };
            modalImg.onerror = () => {
                console.error("Failed to load modal image for restoration:", modalImage);
                modalImg.onload = null; // í•¸ë“¤ëŸ¬ ì œê±°
            };
            modalImg.src = modalImage;
            // ì£¼ì˜: setTimeout ì œê±°í•¨. ì´ë¯¸ì§€ ë¡œë“œ í›„ í‘œì‹œí•˜ë„ë¡ ë³€ê²½.

        } else {
            // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì§€ ì•Šì•„ì•¼ í•˜ëŠ” ê²½ìš° í™•ì‹¤íˆ ë‹«ê¸°
            modal.style.display = 'none';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
        }

        // ì˜¤ë””ì˜¤ ìƒíƒœ ë³µì›
        if (audio) { // audio ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
            if (audioPaused === 'false') {
                // ì €ì¥ëœ ì‹œê°„ìœ¼ë¡œ ì´ë™ í›„ ì¬ìƒ ì‹œë„ (ì‚¬ìš©ì ì¸í„°ë™ì…˜ í•„ìš”í•  ìˆ˜ ìˆìŒ)
                if (audioTime) {
                    audio.currentTime = parseFloat(audioTime);
                }
                audio.play().then(() => {
                    playPauseBtn.textContent = "ğŸ”‡";
                    bar.style.display = "block";
                    console.log('[Web] Audio restored to playing at time:', audio.currentTime);
                }).catch(error => {
                    console.error("Audio play failed on restore:", error);
                    playPauseBtn.textContent = "â™«"; // ì‹¤íŒ¨ ì‹œ UI ì´ˆê¸°í™”
                    bar.style.display = "none";
                    sessionStorage.setItem('audioPaused', 'true'); // ìƒíƒœ ì—…ë°ì´íŠ¸
                });
            } else {
                audio.pause();
                playPauseBtn.textContent = "â™«";
                bar.style.display = "none";
                if (audioTime) { // ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œë„ ì‹œê°„ì€ ë³µì› ê°€ëŠ¥
                    audio.currentTime = parseFloat(audioTime);
                }
                console.log('[Web] Audio restored to paused at time:', audio.currentTime);
            }
        } else {
            console.warn("Audio element #player not found during restoreAppState.");
        }

        console.log('[Web] restoreAppState finished.');
    }

    // --- í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬ ---
    function handleVisibilityChange() {
        if (document.hidden) {
            console.log("Page is hidden");
            // ë²šê½ƒ ìƒì„± ì¤‘ì§€
            if (petalIntervalId) {
                clearInterval(petalIntervalId);
                petalIntervalId = null;
                console.log("Petal interval cleared.");
            }
            // ì„ íƒì : ìŒì•… ì¼ì‹œì •ì§€ (ì‚¬ìš©ì ê²½í—˜ ê³ ë ¤)
            // if (audio && !audio.paused) {
            //     togglePlay(); // ìƒíƒœ ì €ì¥ í¬í•¨
            //     console.log("Audio paused due to page hidden.");
            // }
        } else {
            console.log("Page is visible");
            // ë²šê½ƒ ìƒì„± ë‹¤ì‹œ ì‹œì‘
            if (!petalIntervalId) {
                petalIntervalId = setInterval(createPetal, 500);
                console.log("Petal interval restarted.");
            }
            // ì„ íƒì : í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ ìƒíƒœ ì¬í™•ì¸/ë³µì›
            // restoreAppState();
        }
    }

    document.addEventListener("visibilitychange", handleVisibilityChange);

    // --- ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ---
    window.addEventListener('scroll', () => {
        // ëª¨ë‹¬ ì—´ë ¸ì„ ë•ŒëŠ” ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ì•ˆ í•¨ (bodyê°€ fixed ìƒíƒœì´ë¯€ë¡œ)
        if (document.body.style.position !== 'fixed') {
            sessionStorage.setItem('scrollY', window.scrollY);
        }
    });

    // --- í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ---
    window.addEventListener('load', () => {
        console.log("Page finished loading.");
        // í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ ì´ˆê¸° ìƒíƒœ ë³µì› ì‹œë„ (ì•ˆë“œë¡œì´ë“œ í˜¸ì¶œ ì „ ë°±ì—…)
        // restoreAppState();

        // ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” í”ŒëŸ¬í„° í†µì‹  ì½”ë“œëŠ” ì œê±°í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
        // if (window.flutter_inappwebview) { ... }
        // else if (window.flutter_channel) { ... }
    });

    // --- ì•ˆë“œë¡œì´ë“œì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ í•¨ìˆ˜ ì „ì—­ ë…¸ì¶œ ---
    window.restoreAppState = restoreAppState;

    // --- ìµœì´ˆ ë²šê½ƒ ìƒì„± ì‹œì‘ ---
    if (!petalIntervalId) { // ì´ë¯¸ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‹œì‘
        petalIntervalId = setInterval(createPetal, 500);
    }

</script>
</body>
</html>

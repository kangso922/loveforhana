<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- 필수 Open Graph 태그들 -->
    <meta property="og:title" content="하나의 그림 갤러리 🎨" />
    <meta property="og:description" content="하나떵개의 감성 갤러리 🌸 조용히 감상해요." />
    <meta property="og:image" content="https://kangso922.github.io/loveforhana/images/image8.jpg" />
    <meta property="og:url" content="https://kangso922.github.io/" />
    <meta property="og:type" content="website" />
    <title>하나의 그림 갤러리 🎨</title>
    <link rel="stylesheet" href="style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet"/>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J16EN3BDWW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-J16EN3BDWW');
    </script>
</head>
<body>
<div class="player">
    <audio id="player" src="music/bgm.mp3"></audio>
    <button onclick="togglePlay()" id="playPauseBtn" class="play">♫</button>
    <div id="bar" class="bar"></div>
</div>
<div class="container">
    <h1>하나떵개의 그림들 ✨</h1>
    <div class="gallery">
        <div class="item"><img src="images/image1.jpg" alt="그림 1"/></div>
        <div class="item"><img src="images/image2.jpg" alt="그림 2"/></div>
        <div class="item"><img src="images/image3.jpg" alt="그림 3"/></div>
        <div class="item"><img src="images/image4.jpg" alt="그림 4"/></div>
        <div class="item"><img src="images/image6.jpg" alt="그림 6"/></div>
        <div class="item"><img src="images/image7.jpg" alt="그림 7"/></div>
        <div class="item"><img src="images/image8.jpg" alt="그림 8"/></div>
        <div class="item"><img src="images/image5.jpg" alt="그림 5"/></div>
    </div>

    <!--<div class="music-control">
        <button onclick="document.getElementById('bgm').play()">🎵 음악 듣기</button>
    </div>-->
</div>

<!-- 모달 -->
<div class="modal" id="modal">
    <span class="close" id="close">×</span>
    <img class="modal-content" id="modal-img"/>
</div>

<audio id="bgm" loop>
    <source src="music/bgm.mp3" type="audio/mpeg"/>
    브라우저가 오디오를 지원하지 않습니다.
</audio>

<script>
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const closeBtn = document.getElementById('close');
    let scrollY = 0;

    document.querySelectorAll('.item img').forEach(img => {
        img.addEventListener('click', () => {
            modalImg.src = img.src;

            scrollY = window.scrollY;

            // 바디 고정
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';

            modal.style.display = 'flex';

            // 세션에 저장
            sessionStorage.setItem('scrollY', scrollY);
            sessionStorage.setItem('isModalOpen', 'true');
            sessionStorage.setItem('modalImage', img.src);

            setTimeout(() => {
                const rect = modalImg.getBoundingClientRect();
                const scrollX = window.scrollX;
                const scrollY = window.scrollY;

                const imageX = rect.left + scrollX;
                const imageY = rect.top + scrollY;
                const imageWidth = rect.width;
                const imageHeight = rect.height;

                createHeartsFromBox(imageX, imageY, imageWidth, imageHeight);
                createParticlesFromBox(imageX, imageY, imageWidth, imageHeight);
            }, 0);
        });
    });

    function closeModal() {
        modal.style.display = 'none';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        window.scrollTo(0, scrollY);

        // 모달 닫힘 상태 저장
        sessionStorage.setItem('isModalOpen', 'false');
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', closeModal);

    function restoreAppState() {
        const lastScroll = sessionStorage.getItem('scrollY');
        const isModalOpen = sessionStorage.getItem('isModalOpen');
        const modalImage = sessionStorage.getItem('modalImage');

        if (lastScroll) {
            window.scrollTo(0, parseInt(lastScroll));
        }

        if (isModalOpen === 'true' && modalImage) {
            modalImg.src = modalImage;
            modal.style.display = 'flex';

            // body 고정
            document.body.style.position = 'fixed';
            document.body.style.top = `-${lastScroll}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
        }
    }

    window.addEventListener('scroll', () => {
        sessionStorage.setItem('scrollY', window.scrollY);
    });

    window.addEventListener('load', () => {
        if (window.flutter_inappwebview) {
            window.flutter_inappwebview.callHandler('pageLoaded');
        } else if (window.flutter_channel) {
            window.flutter_channel.postMessage('pageLoaded');
        }
    });

    // 이건 Flutter에서 호출
    // flutter에서 _controller.runJavaScript('restoreAppState()'); 호출 시 실행됨
    window.restoreAppState = restoreAppState;
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- 필수 Open Graph 태그들 -->
    <meta property="og:title" content="하나의 그림 갤러리 🎨" />
    <meta property="og:description" content="하나떵개의 감성 갤러리 🌸 조용히 감상해요." />
    <meta property="og:image" content="https://kangso922.github.io/loveforhana/images/image8.jpg" />
    <meta property="og:url" content="https://kangso922.github.io/" />
    <meta property="og:type" content="website" />
    <title>하나의 그림 갤러리 🎨</title>
    <link rel="stylesheet" href="style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet"/>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J16EN3BDWW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-J16EN3BDWW');
    </script>
</head>
<body>
<div class="player">
    <audio id="player" src="music/bgm.mp3"></audio>
    <button onclick="togglePlay()" id="playPauseBtn" class="play">♫</button>
    <div id="bar" class="bar"></div>
</div>
<div class="container">
    <h1>하나떵개의 그림들 ✨</h1>
    <div class="gallery">
        <div class="item"><img src="images/image1.jpg" alt="그림 1"/></div>
        <div class="item"><img src="images/image2.jpg" alt="그림 2"/></div>
        <div class="item"><img src="images/image3.jpg" alt="그림 3"/></div>
        <div class="item"><img src="images/image4.jpg" alt="그림 4"/></div>
        <div class="item"><img src="images/image6.jpg" alt="그림 6"/></div>
        <div class="item"><img src="images/image7.jpg" alt="그림 7"/></div>
        <div class="item"><img src="images/image8.jpg" alt="그림 8"/></div>
        <div class="item"><img src="images/image5.jpg" alt="그림 5"/></div>
    </div>

    <!--<div class="music-control">
        <button onclick="document.getElementById('bgm').play()">🎵 음악 듣기</button>
    </div>-->
</div>

<!-- 모달 -->
<div class="modal" id="modal">
    <span class="close" id="close">×</span>
    <img class="modal-content" id="modal-img"/>
</div>

<audio id="bgm" loop>
    <source src="music/bgm.mp3" type="audio/mpeg"/>
    브라우저가 오디오를 지원하지 않습니다.
</audio>

<script>
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const closeBtn = document.getElementById('close');

    let scrollY = 0;

    document.querySelectorAll('.item img').forEach(img => {
        img.addEventListener('click', () => {
            modalImg.src = img.src;

            // 현재 스크롤 위치 저장 + body 고정
            scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';

            modal.style.display = 'flex';

            // 세션에 저장
            sessionStorage.setItem('scrollY', scrollY);
            sessionStorage.setItem('isModalOpen', 'true');
            sessionStorage.setItem('modalImage', img.src);

            // 하트 위치 계산
            setTimeout(() => {
                const rect = modalImg.getBoundingClientRect();
                const scrollX = window.scrollX;
                const scrollY = window.scrollY;

                const imageX = rect.left + scrollX;
                const imageY = rect.top + scrollY;
                const imageWidth = rect.width;
                const imageHeight = rect.height;

                createHeartsFromBox(imageX, imageY, imageWidth, imageHeight);
                createParticlesFromBox(imageX, imageY, imageWidth, imageHeight);
            }, 0);
        });
    });

    // 모달 닫기
    function closeModal() {
        modal.style.display = 'none';

        // body 스타일 원상복구 + 스크롤 위치 되돌리기
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        window.scrollTo(0, scrollY);

        // 모달 닫힘 상태 저장
        sessionStorage.setItem('isModalOpen', 'false');
    }

    closeBtn.addEventListener('click', closeModal);

    modal.addEventListener('click',closeModal);



    function createHeartsFromBox(x, y, width, height) {
        fetch("images/heart-svgrepo-com.svg?cache=" + Date.now())
            .then(res => res.text())
            .then(svgText => {
                // width/height 제거
                let cleanedSvg = svgText
                    .replace(/<svg([^>]*)width="[^"]*"([^>]*)>/, '<svg$1$2>')
                    .replace(/<svg([^>]*)height="[^"]*"([^>]*)>/, '<svg$1$2>');

                // fill/stroke 수정
                cleanedSvg = cleanedSvg
                    .replace(/fill="none"/g, 'fill="#ff6b81"')
                    .replace(/stroke="#[^"]*"/g, 'stroke="none"');

                const centerX = x + width / 2;
                const centerY = y + height / 2;
                const maxRadius = Math.min(width, height) * 0.75;

                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * maxRadius;

                    const offsetX = Math.cos(angle) * radius;
                    const offsetY = Math.sin(angle) * radius;

                    const posX = centerX + offsetX;
                    const posY = centerY + offsetY;

                    const wrapper = document.createElement("div");
                    wrapper.classList.add("floating-heart");
                    wrapper.style.position = "absolute";
                    wrapper.style.left = `${posX}px`;
                    wrapper.style.top = `${posY}px`;
                    wrapper.style.width = "32px";
                    wrapper.style.height = "32px";
                    wrapper.innerHTML = cleanedSvg;

                    document.body.appendChild(wrapper);
                    setTimeout(() => wrapper.remove(), 1500);
                }
            });
    }




    function createParticlesFromBox(x, y, width, height) {
        for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');

            const angle = Math.random() * 2 * Math.PI;
            const radius = Math.random() * Math.min(width, height) * 0.75; // 이미지 크기에 비례

            const offsetX = Math.cos(angle) * radius;
            const offsetY = Math.sin(angle) * radius;


            const px = x + width / 2 + offsetX;
            const py = y + height / 2 + offsetY;

            particle.style.left = `${px}px`;
            particle.style.top = `${py}px`;
            particle.style.position = 'absolute';

            const moveAngle = Math.random() * 2 * Math.PI;
            const dist = Math.random() * 60 + 20;

            particle.style.setProperty('--dest-x', `${Math.cos(angle) * dist}px`);
            particle.style.setProperty('--dest-y', `${Math.sin(angle) * dist}px`);
            particle.style.background = ['#ffc1cc', '#ffd6e8', '#ffb3b3', '#ffe4ec'][Math.floor(Math.random() * 4)];

            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 800);
        }
    }

    function createPetal() {
        const petal = document.createElement("div");
        petal.classList.add("petal");
        petal.innerText = "🌸";

        const startLeft = Math.random() * window.innerWidth;
        const size = Math.random() * 14 + 12; // 12px ~ 26px
        const duration = Math.random() * 5 + 5; // 5s ~ 10s
        const delay = Math.random() * 5;
        const xDrift = Math.random() * 100 - 50 + "px";

        petal.style.left = `${startLeft}px`;
        petal.style.fontSize = `${size}px`;
        petal.style.animationDuration = `${duration}s`;
        petal.style.animationDelay = `${delay}s`;
        petal.style.setProperty('--x-drift', xDrift);

        document.body.appendChild(petal);

        setTimeout(() => petal.remove(), (duration + delay) * 1000);
    }

    // 일정 간격으로 계속 생성
    setInterval(createPetal, 500);

    const audio = document.getElementById("player");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const bar = document.getElementById("bar");

    function togglePlay() {
        if (audio.paused) {
            audio.play();
            playPauseBtn.textContent = "🔇";
            bar.style.display = "block";
            sessionStorage.setItem('audioPaused', 'false'); // 오디오 상태 저장
        } else {
            audio.pause();
            playPauseBtn.textContent = "♫";
            bar.style.display = "none";
            sessionStorage.setItem('audioPaused', 'true'); // 오디오 상태 저장
        }
        // 현재 시간 저장
         sessionStorage.setItem('audioTime', audio.currentTime);
    }

    // --- 오디오 상태 복원 ---
    function restoreAppState() {
        // ... (기존 스크롤, 모달 복원 로직) ...

        const audioPaused = sessionStorage.getItem('audioPaused');
        // const audioTime = sessionStorage.getItem('audioTime'); // 필요시 시간 복원

        if (audioPaused === 'false') {
            // 저장된 상태가 '재생 중' 이었으면 다시 재생
            // 사용자와 상호작용 없이 바로 play() 호출은 일부 브라우저/웹뷰에서 막힐 수 있으므로 주의
            // play()가 Promise를 반환하므로 .catch()로 오류 처리 권장
            audio.play().then(() => {
                playPauseBtn.textContent = "🔇";
                bar.style.display = "block";
                // if (audioTime) audio.currentTime = parseFloat(audioTime); // 시간 복원
            }).catch(error => {
                console.error("Audio play failed:", error);
                // 자동 재생 실패 시 UI를 초기 상태로 되돌릴 수 있음
                playPauseBtn.textContent = "♫";
                bar.style.display = "none";
                sessionStorage.setItem('audioPaused', 'true');
            });
        } else {
            // '일시정지' 상태였거나 저장된 값 없으면 기본값 (일시정지)
            audio.pause();
            playPauseBtn.textContent = "♫";
            bar.style.display = "none";
        }

        console.log('[Web] restoreAppState 실행됨', lastScroll, isModalOpen, modalImage, 'Audio Paused:', audioPaused);
    }

    // --- 페이지 표시 상태 변경 시 처리 ---
    let petalIntervalId = null; // 벚꽃 생성 interval ID 저장용

    function handleVisibilityChange() {
        if (document.hidden) {
            // 페이지가 숨겨짐 (앱 백그라운드 등)
            console.log("Page is hidden");
            // 음악 일시정지 (선택적: 사용자가 원하지 않을 수 있음)
            // if (!audio.paused) {
            //     togglePlay(); // 상태 저장 포함
            // }
            // 벚꽃 생성 중지
            if (petalIntervalId) {
                clearInterval(petalIntervalId);
                petalIntervalId = null;
            }
        } else {
            // 페이지가 다시 보여짐 (앱 포그라운드 등)
            console.log("Page is visible");
            // 벚꽃 생성 다시 시작
            if (!petalIntervalId) {
                petalIntervalId = setInterval(createPetal, 500);
            }
            // 필요하다면 여기서 restoreAppState() 재호출 고려 (더 확실한 복원 위해)
            // restoreAppState();
        }
    }

    document.addEventListener("visibilitychange", handleVisibilityChange);

    // 최초 벚꽃 생성 시작
    petalIntervalId = setInterval(createPetal, 500);

    function restoreAppState() {
        const lastScroll = sessionStorage.getItem('scrollY');
        const isModalOpen = sessionStorage.getItem('isModalOpen');
        const modalImage = sessionStorage.getItem('modalImage');

        if (lastScroll) {
            window.scrollTo(0, parseInt(lastScroll));
        }

        if (isModalOpen === 'true' && modalImage) {
            if (isModalOpen === 'true' && modalImage) {
                setTimeout(() => {
                    modalImg.src = modalImage;
                    modal.style.display = 'flex';

                    document.body.style.position = 'fixed';
                    document.body.style.top = `-${lastScroll}px`;
                    document.body.style.left = '0';
                    document.body.style.right = '0';
                    document.body.style.width = '100%';
                }, 50); // ← 여기 지연
            }
        }
        console.log('[Web] restoreAppState 실행됨', lastScroll, isModalOpen, modalImage);

    }

    window.addEventListener('scroll', () => {
        sessionStorage.setItem('scrollY', window.scrollY);
    });

    window.addEventListener('load', () => {
        if (window.flutter_inappwebview) {
            window.flutter_inappwebview.callHandler('pageLoaded');
        } else if (window.flutter_channel) {
            window.flutter_channel.postMessage('pageLoaded');
        }
    });

    // 이건 Flutter에서 호출
    // flutter에서 _controller.runJavaScript('restoreAppState()'); 호출 시 실행됨
    window.restoreAppState = restoreAppState;

</script>
</body>
</html>

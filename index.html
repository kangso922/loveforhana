<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- í•„ìˆ˜ Open Graph íƒœê·¸ë“¤ -->
    <meta property="og:title" content="í•˜ë‚˜ì˜ ê·¸ë¦¼ ê°¤ëŸ¬ë¦¬ ğŸ¨" />
    <meta property="og:description" content="í•˜ë‚˜ë–µê°œì˜ ê°ì„± ê°¤ëŸ¬ë¦¬ ğŸŒ¸ ì¡°ìš©íˆ ê°ìƒí•´ìš”." />
    <meta property="og:image" content="https://kangso922.github.io/loveforhana/images/image8.jpg" />
    <meta property="og:url" content="https://kangso922.github.io/" />
    <meta property="og:type" content="website" />
    <title>í•˜ë‚˜ì˜ ê·¸ë¦¼ ê°¤ëŸ¬ë¦¬ ğŸ¨</title>
    <link rel="stylesheet" href="style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet"/>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J16EN3BDWW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-J16EN3BDWW');
    </script>
</head>
<body>
<div class="player">
    <audio id="player" src="music/bgm.mp3"></audio>
    <button onclick="togglePlay()" id="playPauseBtn" class="play">â™«</button>
    <div id="bar" class="bar"></div>
</div>
<div class="container">
    <h1>í•˜ë‚˜ë–µê°œì˜ ê·¸ë¦¼ë“¤ âœ¨</h1>
    <div class="gallery">
        <div class="item"><img src="images/image1.jpg" alt="ê·¸ë¦¼ 1"/></div>
        <div class="item"><img src="images/image2.jpg" alt="ê·¸ë¦¼ 2"/></div>
        <div class="item"><img src="images/image3.jpg" alt="ê·¸ë¦¼ 3"/></div>
        <div class="item"><img src="images/image4.jpg" alt="ê·¸ë¦¼ 4"/></div>
        <div class="item"><img src="images/image6.jpg" alt="ê·¸ë¦¼ 6"/></div>
        <div class="item"><img src="images/image7.jpg" alt="ê·¸ë¦¼ 7"/></div>
        <div class="item"><img src="images/image8.jpg" alt="ê·¸ë¦¼ 8"/></div>
        <div class="item"><img src="images/image5.jpg" alt="ê·¸ë¦¼ 5"/></div>
    </div>

    <!--<div class="music-control">
        <button onclick="document.getElementById('bgm').play()">ğŸµ ìŒì•… ë“£ê¸°</button>
    </div>-->
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal">
    <span class="close" id="close">Ã—</span>
    <img class="modal-content" id="modal-img"/>
</div>

<audio id="bgm" loop>
    <source src="music/bgm.mp3" type="audio/mpeg"/>
    ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
</audio>

<script>
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const closeBtn = document.getElementById('close');
    const audio = document.getElementById("player");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const bar = document.getElementById("bar");

    let scrollY = 0;
    let petalIntervalId = null; // ë²šê½ƒ ìƒì„± interval ID ì €ì¥ìš©

    // --- ëª¨ë‹¬ ì—´ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    document.querySelectorAll('.item img').forEach(img => {
        img.addEventListener('click', () => {
            // 1. ëª¨ë‹¬ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì²˜ë¦¬í•  ë‚´ìš© ì •ì˜ (onload í•¸ë“¤ëŸ¬)
            modalImg.onload = () => {
                console.log("Modal image loaded:", modalImg.src);
                // ë¡œë“œ ì™„ë£Œ í›„, ì¢Œí‘œ ê³„ì‚° ë° íš¨ê³¼ ìƒì„±
                const rect = modalImg.getBoundingClientRect();
                createHeartsFromBox(rect.left, rect.top, rect.width, rect.height);
                createParticlesFromBox(rect.left, rect.top, rect.width, rect.height);
                // í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” (ë‹¤ìŒ ì´ë¯¸ì§€ ë¡œë“œë¥¼ ìœ„í•´)
                modalImg.onload = null;
                modalImg.onerror = null;
            };
            // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
            modalImg.onerror = () => {
                console.error("Failed to load modal image:", modalImg.src);
                modalImg.onload = null;
                modalImg.onerror = null;
            };

            // 2. ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„¤ì • (onload í•¸ë“¤ëŸ¬ ì„¤ì • í›„)
            modalImg.src = img.src;

            // 3. í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ë° body ê³ ì •
            scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';

            // 4. ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'flex';

            // 5. ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœ ì €ì¥
            sessionStorage.setItem('scrollY', scrollY);
            sessionStorage.setItem('isModalOpen', 'true');
            sessionStorage.setItem('modalImage', img.src);

            // !!! ì¤‘ìš”: í•˜íŠ¸/íŒŒí‹°í´ ìƒì„± í˜¸ì¶œì€ onload í•¸ë“¤ëŸ¬ ì•ˆìœ¼ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±° !!!
            // setTimeout(() => { ... }, 0); ë¶€ë¶„ ì‚­ì œë¨
        });
    });

    // --- ëª¨ë‹¬ ë‹«ê¸° ---
    function closeModal() {
        modal.style.display = 'none';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        // ì €ì¥ëœ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì› ì „ì— ì•½ê°„ì˜ ì§€ì—°ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ (ë Œë”ë§ ì‹œê°„ í™•ë³´)
        // requestAnimationFrame(() => window.scrollTo(0, scrollY));
        window.scrollTo(0, scrollY); // ì¼ë‹¨ ë°”ë¡œ ë³µì› ì‹œë„
        sessionStorage.setItem('isModalOpen', 'false');
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    // --- í•˜íŠ¸ ìƒì„± í•¨ìˆ˜ ---
    function createHeartsFromBox(x, y, width, height) {
        // !!! ì¤‘ìš”: .complete ì²´í¬ ì œê±° !!! (onloadì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ)
        // if (!document.getElementById('modal-img').complete) { ... } ë¶€ë¶„ ì‚­ì œë¨

        fetch("images/heart-svgrepo-com.svg?cache=" + Date.now())
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.text();
            })
            .then(svgText => {
                let cleanedSvg = svgText
                    .replace(/<svg([^>]*)width="[^"]*"([^>]*)>/, '<svg$1$2>')
                    .replace(/<svg([^>]*)height="[^"]*"([^>]*)>/, '<svg$1$2>')
                    .replace(/fill="none"/g, 'fill="#ff6b81"')
                    .replace(/stroke="#[^"]*"/g, 'stroke="none"');

                const centerX = x + width / 2;
                const centerY = y + height / 2;
                const maxRadius = Math.min(width, height) * 0.6;

                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * maxRadius;
                    const offsetX = Math.cos(angle) * radius;
                    const offsetY = Math.sin(angle) * radius;
                    const posX = centerX + offsetX;
                    const posY = centerY + offsetY;

                    const wrapper = document.createElement("div");
                    wrapper.classList.add("floating-heart");
                    wrapper.style.position = "fixed";
                    wrapper.style.left = `${posX}px`;
                    wrapper.style.top = `${posY}px`;
                    wrapper.style.width = "32px";
                    wrapper.style.height = "32px";
                    wrapper.innerHTML = cleanedSvg;

                    document.body.appendChild(wrapper);
                    setTimeout(() => wrapper.remove(), 1500);
                }
            }).catch(error => console.error("Error fetching or processing heart SVG:", error));
    }

    // --- íŒŒí‹°í´ ìƒì„± í•¨ìˆ˜ ---
    function createParticlesFromBox(x, y, width, height) {
        // !!! ì¤‘ìš”: .complete ì²´í¬ ì œê±° !!! (onloadì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ)
        // if (!document.getElementById('modal-img').complete) { ... } ë¶€ë¶„ ì‚­ì œë¨

        for (let i = 0; i < 12; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');

            const angle = Math.random() * 2 * Math.PI;
            const radius = Math.random() * Math.min(width, height) * 0.6;
            const offsetX = Math.cos(angle) * radius;
            const offsetY = Math.sin(angle) * radius;

            const px = x + width / 2 + offsetX;
            const py = y + height / 2 + offsetY;

            particle.style.left = `${px}px`;
            particle.style.top = `${py}px`;
            particle.style.position = 'fixed';

            const moveAngle = Math.random() * 2 * Math.PI;
            const dist = Math.random() * 60 + 20;

            particle.style.setProperty('--dest-x', `${Math.cos(moveAngle) * dist}px`);
            particle.style.setProperty('--dest-y', `${Math.sin(moveAngle) * dist}px`);
            particle.style.background = ['#ffc1cc', '#ffd6e8', '#ffb3b3', '#ffe4ec'][Math.floor(Math.random() * 4)];

            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 800);
        }
    }

    // --- ë²šê½ƒì ìƒì„± í•¨ìˆ˜ ---
    function createPetal() {
        const petal = document.createElement("div");
        petal.classList.add("petal");
        petal.innerText = "ğŸŒ¸";
        const startLeft = Math.random() * window.innerWidth;
        const size = Math.random() * 14 + 12;
        const duration = Math.random() * 5 + 5;
        const delay = Math.random() * 5;
        const xDrift = Math.random() * 100 - 50 + "px";
        petal.style.left = `${startLeft}px`;
        petal.style.fontSize = `${size}px`;
        petal.style.animationDuration = `${duration}s`;
        petal.style.animationDelay = `${delay}s`;
        petal.style.setProperty('--x-drift', xDrift);
        document.body.appendChild(petal);
        setTimeout(() => petal.remove(), (duration + delay) * 1000);
    }

    // --- ì˜¤ë””ì˜¤ ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€ ---
    function togglePlay() {
        if (!audio) return;
        if (audio.paused) {
            audio.play().then(() => {
                playPauseBtn.textContent = "ğŸ”‡";
                bar.style.display = "block";
                sessionStorage.setItem('audioPaused', 'false');
                sessionStorage.setItem('audioTime', audio.currentTime);
            }).catch(error => {
                console.error("Audio play failed:", error);
                playPauseBtn.textContent = "â™«";
                bar.style.display = "none";
                sessionStorage.setItem('audioPaused', 'true');
            });
        } else {
            audio.pause();
            playPauseBtn.textContent = "â™«";
            bar.style.display = "none";
            sessionStorage.setItem('audioPaused', 'true');
            sessionStorage.setItem('audioTime', audio.currentTime);
        }
    }
    playPauseBtn.addEventListener('click', togglePlay);

    // --- ìƒíƒœ ë³µì› í•¨ìˆ˜ (ìœ ì¼í•œ ì •ì˜, ì˜¤ë””ì˜¤ ë³µì› í¬í•¨) ---
    // HTML <script>ì˜ restoreAppState í•¨ìˆ˜ ìˆ˜ì • (ê·¹ë„ë¡œ ìƒì„¸í•œ ë¡œê¹…)

    function restoreAppState() {
        console.log('[Web] +++++ restoreAppState START +++++');
        try {
            // --- 1. ê°’ ì½ê¸° ---
            const lastScroll = sessionStorage.getItem('scrollY');
            const isModalOpen = sessionStorage.getItem('isModalOpen');
            const modalImage = sessionStorage.getItem('modalImage');
            const audioPaused = sessionStorage.getItem('audioPaused');
            const audioTime = sessionStorage.getItem('audioTime');
            console.log('[Web] 1. Read from sessionStorage:', { lastScroll, isModalOpen, modalImage, audioPaused, audioTime });

            // --- 2. ìŠ¤í¬ë¡¤ ë³µì› ---
            if (lastScroll) {
                const scrollVal = parseInt(lastScroll);
                console.log('[Web] 2. Attempting scroll restore to:', scrollVal);
                // ìŠ¤í¬ë¡¤ì€ ë¹„ë™ê¸° ë Œë”ë§ ê³ ë ¤í•˜ì—¬ ì§€ì—° ìœ ì§€
                setTimeout(() => {
                    window.scrollTo(0, scrollVal);
                    console.log('[Web] 2. Scroll restoration attempted. Current scrollY:', window.scrollY);
                }, 100);
            } else {
                console.log('[Web] 2. No saved scroll position.');
            }

            // --- 3. ëª¨ë‹¬ ë³µì› ---
            console.log('[Web] 3. Checking modal state. isModalOpen:', isModalOpen, 'modalImage:', modalImage);
            if (isModalOpen === 'true' && modalImage) {
                console.log('[Web] 3.1. Attempting to restore modal.');
                modalImg.onload = () => {
                    console.log('[Web] 3.2. Modal image loaded.');
                    modal.style.display = 'flex';
                    document.body.style.position = 'fixed';
                    const topOffset = `-${lastScroll || 0}px`;
                    document.body.style.top = topOffset;
                    document.body.style.left = '0';
                    document.body.style.right = '0';
                    document.body.style.width = '100%';
                    console.log('[Web] 3.3. Modal displayed and body fixed. Top:', topOffset);
                    modalImg.onload = null;
                    modalImg.onerror = null;
                };
                modalImg.onerror = () => {
                    console.error("[Web] 3.E. Failed to load modal image for restoration:", modalImage);
                    modalImg.onload = null;
                    modalImg.onerror = null;
                };
                modalImg.src = modalImage; // í•¸ë“¤ëŸ¬ ì„¤ì • í›„ src ì§€ì •
                console.log('[Web] 3.4. Modal image src set.');
            } else {
                console.log('[Web] 3.5. Ensuring modal is closed.');
                modal.style.display = 'none';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.right = '';
                document.body.style.width = '';
            }

            // --- 4. ì˜¤ë””ì˜¤ ë³µì› ---
            console.log('[Web] 4. Checking audio state. audioPaused:', audioPaused);
            if (audio) {
                const targetTime = audioTime ? parseFloat(audioTime) : 0;
                console.log('[Web] 4.1. Target audio time:', targetTime);
                // ì˜¤ë””ì˜¤ ë¡œë“œ ìƒíƒœ í™•ì¸ í›„ ì‹œê°„ ì„¤ì • ì‹œë„ (ë” ì•ˆì •ì )
                if (audio.readyState >= 1) { // HAVE_METADATA or higher
                    audio.currentTime = targetTime;
                    console.log('[Web] 4.2. Set audio currentTime to:', audio.currentTime);
                } else {
                    // ë¡œë“œê°€ ì•ˆëìœ¼ë©´ ë¡œë“œ í›„ ì‹œê°„ ì„¤ì • ì‹œë„
                    audio.onloadedmetadata = () => {
                        audio.currentTime = targetTime;
                        console.log('[Web] 4.2. (onloadedmetadata) Set audio currentTime to:', audio.currentTime);
                        audio.onloadedmetadata = null; // í•¸ë“¤ëŸ¬ ì œê±°
                    }
                }

                if (audioPaused === 'false') {
                    console.log('[Web] 4.3. Attempting to play audio.');
                    // play()ëŠ” ì‚¬ìš©ìì˜ ìƒí˜¸ì‘ìš© í›„ì—ë§Œ ì„±ê³µí•  ê°€ëŠ¥ì„±ì´ ë†’ìŒ (íŠ¹íˆ ëª¨ë°”ì¼)
                    audio.play().then(() => {
                        playPauseBtn.textContent = "ğŸ”‡";
                        bar.style.display = "block";
                        console.log('[Web] 4.4. Audio play success.');
                    }).catch(error => {
                        console.error("[Web] 4.E. Audio play failed on restore:", error);
                        playPauseBtn.textContent = "â™«";
                        bar.style.display = "none";
                        sessionStorage.setItem('audioPaused', 'true'); // ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    });
                } else {
                    console.log('[Web] 4.5. Setting audio to paused.');
                    audio.pause();
                    playPauseBtn.textContent = "â™«";
                    bar.style.display = "none";
                }
            } else {
                console.warn("[Web] 4.W. Audio element #player not found.");
            }
        } catch (error) {
            // í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ëª¨ë“  ì˜¤ë¥˜ ë¡œê¹…
            console.error('[Web] !!!!! CRITICAL Error inside restoreAppState !!!!!', error, error.stack);
        } finally {
            console.log('[Web] ----- restoreAppState END -----');
        }
    }

    // --- !!! ì¤‘ìš”: ì „ì—­ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ ì¶”ê°€ !!! ---
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("[Web] Global Uncaught Error:", {
            message: message,
            source: source,
            lineno: lineno,
            colno: colno,
            errorObject: error
        });
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ trueë¥¼ ë°˜í™˜í•˜ë©´ ë¸Œë¼ìš°ì € ì½˜ì†”ì— ê¸°ë³¸ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ì§€ ì•Šë„ë¡ í•  ìˆ˜ ìˆìŒ
        // return true;
    };

    window.addEventListener('unhandledrejection', function(event) {
        console.error('[Web] Global Unhandled Promise Rejection:', event.reason);
    });


    // --- í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬ ---
    function handleVisibilityChange() {
        if (document.hidden) {
            console.log("Page is hidden");
            if (petalIntervalId) {
                clearInterval(petalIntervalId);
                petalIntervalId = null;
                console.log("Petal interval cleared.");
            }
            // ì„ íƒì : ìŒì•… ì¼ì‹œì •ì§€
            // if (audio && !audio.paused) { togglePlay(); }
        } else {
            console.log("Page is visible");
            if (!petalIntervalId) {
                petalIntervalId = setInterval(createPetal, 500);
                console.log("Petal interval restarted.");
            }
            // ì„ íƒì : í˜ì´ì§€ ë³´ì¼ ë•Œ ìƒíƒœ ì¬í™•ì¸/ë³µì›
            // restoreAppState();
        }
    }
    document.addEventListener("visibilitychange", handleVisibilityChange);

    // --- ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ---
    window.addEventListener('scroll', () => {
        if (document.body.style.position !== 'fixed') {
            sessionStorage.setItem('scrollY', window.scrollY);
        }
    });

    // --- í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ---
    window.addEventListener('load', () => {
        console.log("Page finished loading.");
        // ì„ íƒì : ì´ˆê¸° ìƒíƒœ ë³µì› ì‹œë„
        // restoreAppState();
        // ë¶ˆí•„ìš” í”ŒëŸ¬í„° í†µì‹  ì½”ë“œ ì œê±°ë¨
    });

    // --- ì•ˆë“œë¡œì´ë“œì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ í•¨ìˆ˜ ì „ì—­ ë…¸ì¶œ ---
    window.restoreAppState = restoreAppState;

    // --- ìµœì´ˆ ë²šê½ƒ ìƒì„± ì‹œì‘ ---
    if (!petalIntervalId) {
        petalIntervalId = setInterval(createPetal, 500);
    }

    // !!! ì¤‘ìš”: ìŠ¤í¬ë¦½íŠ¸ ëì— ìˆë˜ ì¤‘ë³µ restoreAppState í•¨ìˆ˜ ì •ì˜ ì œê±°ë¨ !!!

</script>
</body>
</html>
